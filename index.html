<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Random Portal</title>
  <meta name="description" content="Kliknij 'Zabierz mnie' i poleƒá losowo gdzie≈õ w internet." />

  <style>
    :root{
      --bg:#0b0e14;
      --card:#0f1624cc;
      --text:#e9f0ff;
      --muted:#a9b4c7;
      --stroke:#24324a;
      --accent:#7cf7ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background:
        radial-gradient(900px 500px at 20% 20%, #15203a 0%, transparent 60%),
        radial-gradient(700px 500px at 80% 40%, #2a1641 0%, transparent 60%),
        radial-gradient(600px 600px at 50% 90%, #0f3a34 0%, transparent 55%),
        var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding:24px;
    }
    .card{
      width:min(920px,100%);
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:22px;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    h1{margin:0 0 8px 0; font-size:clamp(22px,3.2vw,34px)}
    p{margin:0 0 14px 0; color:var(--muted); line-height:1.35}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:14px;}
    button, select{
      border:1px solid var(--stroke);
      background:#0b1220;
      color:var(--text);
      border-radius:14px;
      padding:12px 14px;
      font-size:15px;
      outline:none;
    }
    button{
      cursor:pointer;
      font-weight:800;
      border-color: rgba(124,247,255,.35);
      box-shadow: 0 10px 30px rgba(124,247,255,.12);
    }
    button:disabled{
      opacity:.55; cursor:not-allowed;
      box-shadow:none;
    }
    .status{
      margin-top:14px;
      border:1px dashed rgba(124,247,255,.35);
      background:#07111f;
      border-radius:14px;
      padding:12px 14px;
      color:#cfe9ff;
      word-break:break-word;
      min-height:44px;
      display:flex;
      align-items:center;
    }
    .tiny{ font-size:12px; color:var(--muted); margin-top:10px }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .label{ color:var(--muted); font-size:13px; margin-right:2px; }
    .split{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      background:#0b1220aa;
    }
    .danger{
      border-color: rgba(255,120,120,.35);
    }
  </style>
</head>

<body>
  <main class="card">
    <h1>üé≤ Random Portal</h1>
    <p>
      Klikasz i otwiera siƒô losowa strona w <b>nowej karcie</b>.
      Portal stara siƒô nie powtarzaƒá ju≈º otwartych link√≥w (pamiƒôta to lokalnie w przeglƒÖdarce).
    </p>

    <div class="row">
      <span class="label">Tryb</span>
      <select id="mode">
        <option value="supabase" selected>Supabase (tabela random_links)</option>
        <option value="mix">Mix (Supabase + randomizery)</option>
        <option value="wiki">Wikipedia (losowy artyku≈Ç)</option>
        <option value="internet">Randomizery (bez Supabase)</option>
      </select>

      <span class="label">Kategoria</span>
      <select id="tag">
        <option value="all" selected>Wszystko</option>
      </select>

      <button id="goBtn" disabled>Zabierz mnie</button>
      <button id="copyBtn" disabled>Kopiuj link</button>
      <button id="shareBtn" disabled>Share</button>
      <button id="resetBtn" class="danger" title="Pozwala losowaƒá te same linki od nowa">Reset historii</button>
    </div>

    <div class="status" id="status">≈Åadujƒô‚Ä¶</div>
    <div class="tiny split">
      <span id="meta">‚Äî</span>
      <span class="pill">Otwartych: <span id="openedCount">0</span></span>
    </div>
  </main>

  <script>
    /**********************
     * Wklej swoje dane:
     * Supabase ‚Üí Project Settings ‚Üí API
     **********************/
    const SUPABASE_URL = "WKLEJ_TU_PROJECT_URL";
    const SUPABASE_ANON_KEY = "WKLEJ_TU_ANON_PUBLIC_KEY";

    /**********************
     * Fallback randomizery
     **********************/
    const randomizers = [
      { url: "https://en.wikipedia.org/wiki/Special:Random", title: "Wikipedia ‚Äì losowy artyku≈Ç" },
      { url: "https://commons.wikimedia.org/wiki/Special:Random/File", title: "Wikimedia ‚Äì losowy plik" },
      { url: "https://www.wikidata.org/wiki/Special:Random", title: "Wikidata ‚Äì losowy wpis" },
      { url: "https://theuselessweb.com/", title: "The Useless Web" }
    ];

    // ile pr√≥b ma zrobiƒá zanim uzna "dobra, nie ma nowych"
    const MAX_UNIQUE_TRIES = 30;

    // localStorage key
    const OPENED_KEY = "rp_opened_urls_v1";

    const $status = document.getElementById("status");
    const $meta = document.getElementById("meta");
    const $mode = document.getElementById("mode");
    const $tag = document.getElementById("tag");
    const $go = document.getElementById("goBtn");
    const $copy = document.getElementById("copyBtn");
    const $share = document.getElementById("shareBtn");
    const $reset = document.getElementById("resetBtn");
    const $openedCount = document.getElementById("openedCount");

    let links = [];
    let lastUrl = "";
    let lastTitle = "";

    function setStatus(msg){ $status.textContent = msg || " "; }
    function setMetaHtml(html){ $meta.innerHTML = html || " "; }
    function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    function normTag(t){
      return (t || "").trim();
    }

    function normalizeUrl(u){
      try {
        const url = new URL(u);
        // normalizacja minimalna: usu≈Ñ trailing slash
        return url.href.replace(/\/$/, "");
      } catch {
        return String(u || "").trim();
      }
    }

    function loadOpenedSet(){
      try{
        const raw = localStorage.getItem(OPENED_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return new Set((arr || []).map(normalizeUrl));
      }catch{
        return new Set();
      }
    }

    function saveOpenedSet(set){
      try{
        localStorage.setItem(OPENED_KEY, JSON.stringify(Array.from(set)));
      }catch{}
      updateOpenedCount(set);
    }

    function updateOpenedCount(set){
      $openedCount.textContent = String(set.size);
    }

    let opened = loadOpenedSet();
    updateOpenedCount(opened);

    function validConfig(){
      return SUPABASE_URL && SUPABASE_ANON_KEY &&
        !SUPABASE_URL.includes("WKLEJ") &&
        !SUPABASE_ANON_KEY.includes("WKLEJ");
    }

    async function fetchLinks(){
      if (!validConfig()) {
        setStatus("Wklej SUPABASE_URL i SUPABASE_ANON_KEY w kodzie (na dole).");
        setMetaHtml("Supabase ‚Üí Project Settings ‚Üí API. Potem od≈õwie≈º stronƒô.");
        return [];
      }

      const endpoint =
        `${SUPABASE_URL}/rest/v1/random_links?select=id,url,title,tag&enabled=eq.true&order=created_at.desc`;

      const res = await fetch(endpoint, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          authorization: `Bearer ${SUPABASE_ANON_KEY}`
        }
      });

      if (!res.ok) {
        const t = await res.text().catch(()=> "");
        setStatus("Nie mogƒô pobraƒá link√≥w z Supabase. Sprawd≈∫ RLS/policy.");
        setMetaHtml(`HTTP ${res.status} ‚Äî ${escapeHtml(t.slice(0, 160))}`);
        return [];
      }

      return await res.json();
    }

    function buildTagOptions(items){
      const tags = Array.from(
        new Set(items.map(x => normTag(x.tag)).filter(Boolean))
      ).sort((a,b)=>a.localeCompare(b));

      const options =
        `<option value="all" selected>Wszystko</option>` +
        tags.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

      $tag.innerHTML = options;
      $tag.disabled = !tags.length;
    }

    function filteredLinks(){
      const selected = $tag.value || "all";
      if (selected === "all") return links;
      return links.filter(l => normTag(l.tag).toLowerCase() === selected.toLowerCase());
    }

    function chooseCandidate(mode){
      const filtered = filteredLinks();

      if (mode === "wiki") {
        return { url: "https://en.wikipedia.org/wiki/Special:Random", title: "Wikipedia ‚Äì losowy artyku≈Ç" };
      }
      if (mode === "internet") {
        return pick(randomizers);
      }

      if (mode === "supabase") {
        if (filtered.length) {
          const it = pick(filtered);
          return { url: it.url, title: it.title || it.url, tag: normTag(it.tag) };
        }
        return pick(randomizers);
      }

      // mix
      if (filtered.length && Math.random() < 0.7) {
        const it = pick(filtered);
        return { url: it.url, title: it.title || it.url, tag: normTag(it.tag) };
      }
      return pick(randomizers);
    }

    function pickUnique(mode){
      // pr√≥bujemy kilka razy znale≈∫ƒá nieotwierany link
      for (let i = 0; i < MAX_UNIQUE_TRIES; i++){
        const it = chooseCandidate(mode);
        const nu = normalizeUrl(it.url);
        if (!opened.has(nu)) return it;
      }
      // je≈õli wszystko siƒô powtarza, zwracamy cokolwiek
      return chooseCandidate(mode);
    }

    function setLast(url, title){
      lastUrl = url;
      lastTitle = title || url;

      const enabled = !!lastUrl;
      $copy.disabled = !enabled;
      $share.disabled = !enabled;
    }

    function currentTagLabel(){
      const v = $tag.value || "all";
      if (v === "all") return "";
      return ` | kategoria: ${v}`;
    }

    function openInNewTab(url){
      // "_blank" + "noopener,noreferrer" ≈ºeby by≈Ço bezpiecznie
      const win = window.open(url, "_blank", "noopener,noreferrer");
      if (!win) {
        // je≈õli popup blocker zablokuje
        setStatus("PrzeglƒÖdarka zablokowa≈Ça otwarcie nowej karty (popup). Kliknij link poni≈ºej rƒôcznie.");
        setMetaHtml(`<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`);
      }
    }

    $go.addEventListener("click", () => {
      const mode = $mode.value;
      const it = pickUnique(mode);

      const nu = normalizeUrl(it.url);
      const wasOpened = opened.has(nu);

      // zapamiƒôtaj jako otwarte
      opened.add(nu);
      saveOpenedSet(opened);

      setStatus(`Otwieram: ${it.title}${currentTagLabel()}${wasOpened ? " (powt√≥rka)" : ""}`);
      setMetaHtml(`<a href="${escapeHtml(it.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(it.url)}</a>`);

      setLast(it.url, it.title);
      openInNewTab(it.url);
    });

    $copy.addEventListener("click", async () => {
      if (!lastUrl) return;
      try {
        await navigator.clipboard.writeText(lastUrl);
        setStatus("Skopiowane ‚úÖ");
        setMetaHtml(`<a href="${escapeHtml(lastUrl)}" target="_blank" rel="noopener noreferrer">${escapeHtml(lastUrl)}</a>`);
      } catch {
        setStatus("Nie mogƒô skopiowaƒá automatycznie ‚Äî masz link poni≈ºej:");
        setMetaHtml(`<a href="${escapeHtml(lastUrl)}" target="_blank" rel="noopener noreferrer">${escapeHtml(lastUrl)}</a>`);
      }
    });

    $share.addEventListener("click", async () => {
      if (!lastUrl) return;

      const tagTxt = ($tag.value && $tag.value !== "all") ? ` (${ $tag.value })` : "";
      const text = `Random Portal${tagTxt}: ${lastUrl}`;

      if (navigator.share) {
        try {
          await navigator.share({ title: "Random Portal", text, url: lastUrl });
          return;
        } catch (_) {}
      }

      // fallback: kopiuj do schowka
      try {
        await navigator.clipboard.writeText(lastUrl);
        setStatus("Skopiowane (share fallback) ‚úÖ");
        setMetaHtml(`<a href="${escapeHtml(lastUrl)}" target="_blank" rel="noopener noreferrer">${escapeHtml(lastUrl)}</a>`);
      } catch {
        setStatus("Share nie dzia≈Ça ‚Äî masz link poni≈ºej:");
        setMetaHtml(`<a href="${escapeHtml(lastUrl)}" target="_blank" rel="noopener noreferrer">${escapeHtml(lastUrl)}</a>`);
      }
    });

    $reset.addEventListener("click", () => {
      opened = new Set();
      saveOpenedSet(opened);
      setStatus("Zresetowane. Mo≈ºesz odkrywaƒá od nowa.");
      setMetaHtml("Kliknij ‚ÄûZabierz mnie‚Äù.");
      setLast("", "");
      $copy.disabled = true;
      $share.disabled = true;
    });

    $tag.addEventListener("change", () => {
      const filtered = filteredLinks();
      if ($tag.value === "all") {
        setStatus(`Kategoria: Wszystko (${links.length} link√≥w).`);
      } else {
        setStatus(`Kategoria: ${$tag.value} (${filtered.length} link√≥w).`);
      }
      setMetaHtml("Kliknij ‚ÄûZabierz mnie‚Äù.");
    });

    (async function init(){
      setStatus("≈Åadujƒô linki z Supabase‚Ä¶");
      links = await fetchLinks();

      if (!validConfig()) {
        $go.disabled = true;
        $copy.disabled = true;
        $share.disabled = true;
        $tag.disabled = true;
        return;
      }

      if (links.length) {
        buildTagOptions(links);
        setStatus(`Gotowe. Link√≥w w bazie: ${links.length}. Kliknij ‚ÄûZabierz mnie‚Äù.`);
        setMetaHtml("Tip: dodawaj tagi (kategorie) w Supabase ‚Üí random_links.");
        $go.disabled = false;
      } else {
        setStatus("W bazie nie ma link√≥w (albo wszystkie disabled). U≈ºyjƒô fallback√≥w.");
        setMetaHtml("Tryb MIX/Wiki/Internet nadal dzia≈Ça.");
        $go.disabled = false;
        $tag.disabled = true;
      }
    })();
  </script>
</body>
</html>
